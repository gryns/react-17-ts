# 发布订阅模式

发布订阅有三部分组成，分为 Publisher(发布)、消息池(Topic)、Subscriber(订阅)组成。订阅者（Subscriber）把自己想订阅的的事件注册到消息池里(Topic)里，当发布者（Publisher）发布该事件时，也是从消息池里执行代码。我们用的 vue 里的$on和$emit 就是发布订阅模式，还有 NodeJs 中 EventEmmiter。

# 例子

比如我们喜欢某个公众号，我们关注了 TA(这里就是订阅了)，当公众号管理员发布新文章时，我们会收到新文章的消息提示，其实这就是一个发布/订单流程。公众号管理员（Publisher）就是发布者。我们关注公众号就是订阅者（Subscriber）。当管理员发布文章时，通知调度中心及时发消息通知订阅者

# 实现思路

- 创建一个对象
- 在改对象上添加缓存列表(消息池)
- 创建 on 方法函数来订阅
- 创建 emit 方法函数来发布
- 创建 off 方法函数来取消订阅

# 例子

```javascript
class Publisher {
	constructor() {
		this.topic = {}
	}
	// 订阅
	on(key, handle) {
		if (!this.topic[key]) {
			this.topic[key] = []
		}
		this.topic[key].push(handle)
	}
	// 发布
	emit(key, ...rest) {
		const that = this
		if (!this.topic[key]) return
		this.topic[key].forEach((element) => {
			element.apply(that, rest)
		})
	}
	// 取消订阅
	off(key, handle) {
		if (!this.topic[key]) return
		const delIndex = this.topic[key].findIndex((item) => item === handle)
		console.log("取消订阅")
		this.topic[key].splice(delIndex, 1)
	}
	// 执行一次
	once(key, handle) {
		/**
		 * 有必要说明一下，这里注册时，是runOnce函数，发布消息执行的是runOnce函数，并非handle传递过来的函数
		 * **/
		const that = this
		function runOnce() {
			that.off(key, runOnce)
			handle.apply(that, arguments)
		}
		this.on(key, runOnce)
	}
}
const publish = new Publisher()
const els = function (name) {
	console.log("乌克兰", name)
}
const wkl = function (name) {
	console.log("俄罗斯", name)
}
const usa = function (name) {
	console.log("美国", name)
}
const rb = function (name) {
	console.log("日本", name)
}
console.log("111")
publish.on("war", els)
publish.on("war", wkl)
publish.on("war", usa)
publish.once("war", rb)
publish.emit("war", "在打仗")
publish.off("war", usa)
console.log("*******")
publish.emit("war", "在打仗")
```
